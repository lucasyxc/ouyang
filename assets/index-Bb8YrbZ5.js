import{_ as ne,r as u,H as oe,o as re,j as se,k as de,a as ue,c as a,w as t,h as ie,g as ve,b as c,R as ce,l as pe,B as _e,e as p,u as me,P as fe,C as ge,n as we,p as ye,G as be,x as Se,q as xe,M as De,f as ke,d as $e,t as m,v as b,i as Ce}from"./index-BmxR4WCw.js";import{r as M}from"./request-C7sc0_J1.js";import{p as Ie}from"./product-CiH2I8No.js";import{d as Ue}from"./dealer-BS8tfarj.js";const A={getList(S){return M.get("/sale/list",{params:S})},create(S){return M.post("/sale/create/",S)},update(S,L){return M.post(`/sale/edit/${S}/`,L)}},Le={class:"sale-container"},he=["onClick"],Oe=["onClick"],Ne={__name:"index",setup(S){const L=se(),E=de(),D=u([]),j=u(""),C=u(""),I=u(""),U=u(""),G=l=>{console.log("日期范围变化:",l)},H=()=>{console.log("搜索关键词:",j.value)},P=u([]),h=u(!1),O=u([]),N=u([]),k=u(!1),R=u("新增销售记录"),Y=u(!1),r=u({}),F=u(null),q=u(!1),s=u({}),K=[{title:"销售日期",dataIndex:"sale_date",key:"sale_date",width:120},{title:"产品名称",key:"product_name",width:200,customRender:({record:l})=>l.medical_device?`${l.medical_device.name} ${l.medical_device.model}`:""},{title:"序列号",dataIndex:"device_code",key:"device_code",width:150},{title:"客户单位",key:"dealer_name",width:200,customRender:({record:l})=>l.dealer?`${l.dealer.contact_person} - ${l.dealer.name}`:""},{title:"区域",key:"dealer_area",width:120,customRender:({record:l})=>l.dealer?l.dealer.area:""},{title:"经办人",dataIndex:"handler_name",key:"handler_name",width:120},{title:"复核人",dataIndex:"reviewer_name",key:"reviewer_name",width:120},{title:"操作",key:"action",width:150,fixed:"right",slots:{customRender:"action"}}],Q={device:[{required:!0,message:"请选择产品",trigger:"change"}],dealer:[{required:!0,message:"请选择客户",trigger:"change"}],sale_date:[{required:!0,message:"请选择销售日期",trigger:"change"}],device_code:[{required:!0,message:"请输入序列号",trigger:"blur"}],handler_name:[{required:!0,message:"请输入经办人姓名",trigger:"blur"}],reviewer_name:[{required:!0,message:"请输入复核人姓名",trigger:"blur"}]},W=oe(()=>P.value.filter(l=>{let e=!0;if(D.value&&D.value.length===2){const[n,i]=D.value,f=new Date(l.sale_date),g=new Date(n),x=new Date(i);e=e&&f>=g&&f<=x}if(C.value&&(e=e&&l.dealer&&l.dealer.area&&l.dealer.area.toLowerCase().includes(C.value.toLowerCase())),I.value){let n="";l.dealer&&(n=`${l.dealer.contact_person} - ${l.dealer.name}`),e=e&&n.toLowerCase().includes(I.value.toLowerCase())}if(U.value){let n="";l.medical_device&&(n=`${l.medical_device.name} ${l.medical_device.model}`),e=e&&n.toLowerCase().includes(U.value.toLowerCase())}return e})),V=async()=>{h.value=!0;try{const l=localStorage.getItem("user");let e="";if(l)try{e=JSON.parse(l).id}catch(i){console.error("解析 localStorage 中 user 出错:",i)}console.log("发送给后端的用户id参数:",e);const n=await A.getList({user_id:e});if(console.log("后端返回的销售记录数据:",n),n.status==="success"){P.value=n.sales;try{localStorage.setItem("sales",JSON.stringify(n.sales)),console.log("销售记录已保存至 localStorage")}catch(i){console.error("保存销售记录到 localStorage 失败:",i)}}else b.error("获取销售记录失败")}catch{b.error("获取销售记录失败")}finally{h.value=!1}},X=async()=>{try{const l=localStorage.getItem("products");if(l){const e=JSON.parse(l);O.value=e.map(n=>({label:`${n.name}-${n.model}-${n.manufacturer}`,value:n.id}))}else{const e=await Ie.getList();O.value=e.data.map(n=>({label:`${n.name}-${n.model}-${n.manufacturer}`,value:n.id}))}}catch{b.error("获取产品列表失败")}},Z=async()=>{try{const l=localStorage.getItem("dealers");if(l){const e=JSON.parse(l);N.value=e.map(n=>({label:`${n.name}-${n.contact_person}-${n.area||""}`,value:n.id}))}else{const e=await Ue.getList();N.value=e.data.map(n=>({label:`${n.name}-${n.contact_person}-${n.area||""}`,value:n.id}))}}catch{b.error("获取客户列表失败")}},B=()=>{R.value="新增销售记录",r.value={sale_date:new Date().toISOString().split("T")[0],reviewer_name:"欧阳志燕",handler_name:"苏青英"},k.value=!0},ee=l=>{R.value="编辑销售记录",r.value={...l},l.medical_device&&(r.value.device=l.medical_device.id),l.dealer&&(r.value.dealer=l.dealer.id),k.value=!0},ae=async()=>{try{await F.value.validate(),Y.value=!0;const l=localStorage.getItem("user");let e="";if(l)try{e=JSON.parse(l).id}catch(y){console.error("解析 localStorage 中 user 出错:",y)}let n=new FormData;n.append("device_code",r.value.device_code||""),n.append("manufacture_date",r.value.manufacture_date||""),n.append("user_id",e),n.append("medical_device_id",r.value.device||""),n.append("dealer_id",r.value.dealer||""),n.append("handler_name",r.value.handler_name||""),n.append("reviewer_name",r.value.reviewer_name||""),n.append("sale_date",r.value.sale_date||"");let i="";const f=localStorage.getItem("products");if(f){const w=JSON.parse(f).find(v=>v.id==r.value.device);w&&(i=JSON.stringify(w))}n.append("product_detail",i);let g="";const x=localStorage.getItem("dealers");if(x){const w=JSON.parse(x).find(v=>v.id==r.value.dealer);w&&(g=JSON.stringify(w))}n.append("dealer_detail",g),r.value.id?(await A.update(r.value.id,n),b.success("更新成功")):(await A.create(n),b.success("创建成功")),k.value=!1,V()}catch(l){console.error("表单提交错误:",l),b.error("操作失败")}finally{Y.value=!1}},le=l=>{s.value=l,q.value=!0};return re(()=>{V(),X(),Z(),L.query.modal==="add"&&(B(),E.replace({query:{}}))}),(l,e)=>{const n=ce,i=pe,f=_e,g=ve,x=ie,y=ge,w=be,v=ye,T=Se,J=xe,te=we,z=De,d=$e,_=ke;return Ce(),ue("div",Le,[a(y,{title:"销售记录"},{extra:t(()=>[a(g,null,{default:t(()=>[a(n,{value:D.value,"onUpdate:value":e[0]||(e[0]=o=>D.value=o),onChange:G,"value-format":"YYYY-MM-DD"},null,8,["value"]),a(i,{value:C.value,"onUpdate:value":e[1]||(e[1]=o=>C.value=o),placeholder:"搜索区域",style:{width:"200px"}},null,8,["value"]),a(i,{value:I.value,"onUpdate:value":e[2]||(e[2]=o=>I.value=o),placeholder:"搜索客户单位",style:{width:"200px"}},null,8,["value"]),a(i,{value:U.value,"onUpdate:value":e[3]||(e[3]=o=>U.value=o),placeholder:"搜索产品",style:{width:"200px"}},null,8,["value"]),a(f,{type:"primary",onClick:H},{default:t(()=>e[13]||(e[13]=[p(" 查询 ")])),_:1}),a(f,{type:"primary",onClick:B},{icon:t(()=>[a(me(fe))]),default:t(()=>[e[14]||(e[14]=p(" 新增销售 "))]),_:1})]),_:1})]),default:t(()=>[a(x,{columns:K,"data-source":W.value,loading:h.value,scroll:{x:1800},"row-key":"id"},{action:t(({record:o})=>[a(g,null,{default:t(()=>[c("a",{onClick:$=>ee(o)},"编辑",8,he),c("a",{onClick:$=>le(o)},"查看",8,Oe)]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1}),a(z,{visible:k.value,"onUpdate:visible":e[11]||(e[11]=o=>k.value=o),title:R.value,"confirm-loading":Y.value,onOk:ae,width:"700px"},{default:t(()=>[a(te,{ref_key:"formRef",ref:F,model:r.value,rules:Q,"label-col":{span:6},"wrapper-col":{span:16}},{default:t(()=>[a(v,{label:"销售日期",name:"sale_date"},{default:t(()=>[a(w,{value:r.value.sale_date,"onUpdate:value":e[4]||(e[4]=o=>r.value.sale_date=o),style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["value"])]),_:1}),a(v,{label:"产品",name:"device"},{default:t(()=>[a(T,{value:r.value.device,"onUpdate:value":e[5]||(e[5]=o=>r.value.device=o),options:O.value,placeholder:"请选择产品",showSearch:"","filter-option":(o,$)=>$.label.toLowerCase().indexOf(o.toLowerCase())>=0},null,8,["value","options","filter-option"])]),_:1}),a(v,{label:"生产日期(选填)",name:"manufacture_date"},{default:t(()=>[a(w,{value:r.value.manufacture_date,"onUpdate:value":e[6]||(e[6]=o=>r.value.manufacture_date=o),style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["value"])]),_:1}),a(v,{label:"序列号",name:"device_code"},{default:t(()=>[a(J,{value:r.value.device_code,"onUpdate:value":e[7]||(e[7]=o=>r.value.device_code=o)},null,8,["value"])]),_:1}),a(v,{label:"客户单位",name:"dealer"},{default:t(()=>[a(T,{value:r.value.dealer,"onUpdate:value":e[8]||(e[8]=o=>r.value.dealer=o),options:N.value,placeholder:"请选择客户",showSearch:"","filter-option":(o,$)=>$.label.toLowerCase().indexOf(o.toLowerCase())>=0},null,8,["value","options","filter-option"])]),_:1}),a(v,{label:"经办人",name:"handler_name"},{default:t(()=>[a(J,{value:r.value.handler_name,"onUpdate:value":e[9]||(e[9]=o=>r.value.handler_name=o)},null,8,["value"])]),_:1}),a(v,{label:"复核人",name:"reviewer_name"},{default:t(()=>[a(J,{value:r.value.reviewer_name,"onUpdate:value":e[10]||(e[10]=o=>r.value.reviewer_name=o)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title","confirm-loading"]),a(z,{visible:q.value,"onUpdate:visible":e[12]||(e[12]=o=>q.value=o),title:"查看销售记录",footer:null,width:"700px"},{default:t(()=>[a(g,{direction:"vertical",style:{width:"100%"}},{default:t(()=>[a(y,{size:"small",title:"产品信息"},{default:t(()=>[a(_,{style:{"margin-bottom":"8px"}},{default:t(()=>[a(d,{span:10},{default:t(()=>e[15]||(e[15]=[c("strong",null,"产品名称与型号:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.medical_device?s.value.medical_device.name+" "+s.value.medical_device.model:"无数据"),1)]),_:1})]),_:1}),a(_,{style:{"margin-bottom":"8px"}},{default:t(()=>[a(d,{span:10},{default:t(()=>e[16]||(e[16]=[c("strong",null,"生产企业:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.medical_device?s.value.medical_device.manufacturer:"无数据"),1)]),_:1})]),_:1}),a(_,{style:{"margin-bottom":"8px"}},{default:t(()=>[a(d,{span:10},{default:t(()=>e[17]||(e[17]=[c("strong",null,"序列号:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.device_code||"无数据"),1)]),_:1})]),_:1}),a(_,null,{default:t(()=>[a(d,{span:10},{default:t(()=>e[18]||(e[18]=[c("strong",null,"生产日期:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.manufacture_date||"无数据"),1)]),_:1})]),_:1})]),_:1}),a(y,{size:"small",title:"客户信息",style:{"margin-top":"16px"}},{default:t(()=>[a(_,{style:{"margin-bottom":"8px"}},{default:t(()=>[a(d,{span:10},{default:t(()=>e[19]||(e[19]=[c("strong",null,"公司名称:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.dealer?s.value.dealer.name:"无数据"),1)]),_:1})]),_:1}),a(_,{style:{"margin-bottom":"8px"}},{default:t(()=>[a(d,{span:10},{default:t(()=>e[20]||(e[20]=[c("strong",null,"联系人:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.dealer?s.value.dealer.contact_person:"无数据"),1)]),_:1})]),_:1}),a(_,{style:{"margin-bottom":"8px"}},{default:t(()=>[a(d,{span:10},{default:t(()=>e[21]||(e[21]=[c("strong",null,"联系电话:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.dealer?s.value.dealer.contact_phone:"无数据"),1)]),_:1})]),_:1}),a(_,{style:{"margin-bottom":"8px"}},{default:t(()=>[a(d,{span:10},{default:t(()=>e[22]||(e[22]=[c("strong",null,"地址:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.dealer?s.value.dealer.address:"无数据"),1)]),_:1})]),_:1}),a(_,null,{default:t(()=>[a(d,{span:10},{default:t(()=>e[23]||(e[23]=[c("strong",null,"区域:",-1)])),_:1}),a(d,{span:14},{default:t(()=>[p(m(s.value.dealer?s.value.dealer.area:"无数据"),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["visible"])])}}},Me=ne(Ne,[["__scopeId","data-v-a709d5e9"]]);export{Me as default};
