import{_ as Z,r as m,o as ee,j as le,k as ae,a as w,c as s,w as o,h as se,g as ne,b as _,l as te,B as oe,e as q,m as J,C as re,n as ie,p as ue,q as ce,s as de,M as _e,v as f,i as h}from"./index-BmxR4WCw.js";import{d as R}from"./dealer-BS8tfarj.js";import"./request-C7sc0_J1.js";const pe={class:"dealer-container"},me=["onClick"],fe=["onClick"],ve={key:0},ge=["src"],be={key:1},we={style:{"margin-top":"20px"}},he={key:0},ye=["src"],xe={key:1},Ue={__name:"index",setup(Ie){const V=le(),z=ae(),C=m([]),F=m(!1),g=m(!1),M=m("新增客户"),j=m(!1),a=m({}),P=m(null),B=m(""),y=m({current:1,pageSize:10,total:0}),A=[{title:"公司名称",dataIndex:"name",key:"name",width:200},{title:"联系人",dataIndex:"contact_person",key:"contact_person",width:120},{title:"地址",dataIndex:"address",key:"address",ellipsis:!0},{title:"区域",dataIndex:"area",key:"area",width:150},{title:"联系电话",dataIndex:"contact_phone",key:"contact_phone",width:150},{title:"营业执照号",dataIndex:"license_number",key:"license_number",width:180},{title:"操作",key:"action",width:150,fixed:"right",slots:{customRender:"action"}}],N={name:[{required:!1,message:"请输入公司名称",trigger:"blur"},{min:2,max:100,message:"长度在 2 到 100 个字符",trigger:"blur"}],contact_person:[{required:!0,message:"请输入联系人",trigger:"blur"}],contact_phone:[{required:!0,message:"请输入联系电话",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}],license_number:[{required:!1,message:"请输入营业执照号",trigger:"blur"}],address:[{required:!0,message:"请输入地址",trigger:"blur"}],area:[{required:!1,message:"请输入区域",trigger:"blur"}],class3_license_number:[{required:!1,message:"请输入三类医疗器械经营许可证编号",trigger:"blur"}],class2_record_number:[{required:!1,message:"请输入二类医疗器械经营备案编号",trigger:"blur"}]},x=m(!1),b=m({class2_record_file:"",class3_license_file:""}),E=l=>{const e="http://oyerp.aiforoptometry.com/media/";b.value.class2_record_file=l.class2_record_file?e+l.class2_record_file:"",b.value.class3_license_file=l.class3_license_file?e+l.class3_license_file:"",x.value=!0},G=()=>{x.value=!1},U=async()=>{F.value=!0;try{const l=localStorage.getItem("user");let e=null;if(l)try{e=JSON.parse(l).id}catch(p){console.error("解析 localStorage 中 user 出错:",p)}console.log("发送给后端的请求参数:",{id:e});const u=await R.getList({id:e});if(console.log("后端返回客户列表数据:",u),u.status==="success"){C.value=u.dealers,y.value.total=C.value.length;try{localStorage.setItem("dealers",JSON.stringify(u.dealers)),console.log("客户列表数据已保存到 localStorage")}catch(p){console.error("保存客户列表到 localStorage 时出错:",p)}}else f.error("获取客户列表失败")}catch{f.error("获取客户列表失败")}finally{F.value=!1}},T=()=>{U()},L=()=>{M.value="新增客户",a.value={},g.value=!0},$=l=>{M.value="编辑客户";const e={...l,name:l.name??"",license_number:l.license_number??"",contact_person:l.contact_person??"",contact_phone:l.contact_phone??"",address:l.address??"",email:l.email??"",note:l.note??"",area:l.area??"",class3_license_number:l.class3_license_number??"",class2_record_number:l.class2_record_number??"",class3_license_file:[],class2_record_file:[]};l.class3_license_file&&(e.class3_license_file=[{uid:"-1",name:"现有文件",status:"done",url:l.class3_license_file}]),l.class2_record_file&&(e.class2_record_file=[{uid:"-1",name:"现有文件",status:"done",url:l.class2_record_file}]),a.value=e,g.value=!0},K=async()=>{var l,e;try{await P.value.validate();const u=localStorage.getItem("user");let p=null;if(u)try{p=JSON.parse(u).id}catch(d){console.error("解析 localStorage 中 user 出错:",d)}j.value=!0;const v=["name","contact_person","contact_phone","license_number","address","area","class3_license_number","class2_record_number","class3_license_file","class2_record_file","email","note"];if(a.value.id){const d=a.value.id,c=new FormData;v.forEach(t=>{if(t==="class3_license_file"||t==="class2_record_file")if(Array.isArray(a.value[t])&&a.value[t].length>0){const i=a.value[t][0];i.originFileObj?c.append(t,i.originFileObj):c.append(t,i.url||"")}else c.append(t,"");else c.append(t,a.value[t]??"")}),c.append("id",p),console.log("发送给后端的更新数据:");for(let[t,i]of c.entries())console.log(t,i);const r=await R.update(d,c);console.log("后端返回更新客户数据:",r),f.success("更新客户信息成功")}else{const d=new FormData;v.forEach(r=>{if(a.value.hasOwnProperty(r))if(Array.isArray(a.value[r]))if(a.value[r].length>0){const t=a.value[r][0];d.append(r,t.originFileObj||t)}else d.append(r,"");else d.append(r,a.value[r]??"");else d.append(r,"")}),d.append("id",p),console.log("发送给后端的新增数据:");for(let[r,t]of d.entries())console.log(r,t);const c=await R.create(d);console.log("后端返回新增客户数据:",c),f.success("新增客户成功")}g.value=!1,U()}catch(u){console.error("表单提交错误:",u),f.error(((e=(l=u.response)==null?void 0:l.data)==null?void 0:e.message)||"操作失败，请重试")}finally{j.value=!1}},W=l=>{y.value.current=l.current,y.value.pageSize=l.pageSize,U()},H=()=>{var l;(l=P.value)==null||l.resetFields(),a.value={}},Q=()=>{g.value=!1,H()},O=(l,e)=>{const u=l.type==="image/jpeg",p=l.type==="application/pdf";if(e==="class3"){if(!u)return f.error("三类许可证仅支持JPG格式"),!1;if(!(l.size/1024/1024<1.8))return f.error("文件大小不能超过1.8MB"),!1;if(l.size/1024/1024>1.7)return new Promise(d=>{const c=new Image;c.src=URL.createObjectURL(l),c.onload=()=>{const r=document.createElement("canvas"),t=r.getContext("2d"),i=1200,I=i/c.width;r.width=i,r.height=c.height*I,t.drawImage(c,0,0,r.width,r.height),r.toBlob(S=>{d(new File([S],l.name,{type:"image/jpeg",lastModified:Date.now()}))},"image/jpeg",.8)}})}if(e==="class2"){if(!u&&!p)return f.error("二类备案凭证仅支持JPG和PDF格式"),!1;if(!(l.size/1024/1024<5))return f.error("文件大小不能超过5MB"),!1}return!0},k=l=>{const u=l.url.startsWith("http")?l.url:"http://oyerp.aiforoptometry.com/media/"+l.url;window.open(u,"_blank")};return ee(()=>{U(),V.query.modal==="add"&&(L(),z.replace({query:{}}))}),(l,e)=>{const u=te,p=J("plus-outlined"),v=oe,d=ne,c=se,r=re,t=ce,i=ue,I=J("upload-outlined"),S=de,X=ie,D=_e;return h(),w("div",pe,[s(r,{title:"客户管理"},{extra:o(()=>[s(d,null,{default:o(()=>[s(u,{value:B.value,"onUpdate:value":e[0]||(e[0]=n=>B.value=n),placeholder:"搜索客户",style:{width:"200px"},onSearch:T},null,8,["value"]),s(v,{type:"primary",onClick:L},{icon:o(()=>[s(p)]),default:o(()=>[e[13]||(e[13]=q(" 新增客户 "))]),_:1})]),_:1})]),default:o(()=>[s(c,{columns:A,"data-source":C.value,loading:F.value,pagination:y.value,scroll:{x:1300},"row-key":"id",onChange:W},{action:o(({record:n})=>[s(d,null,{default:o(()=>[_("a",{onClick:Y=>$(n)},"编辑",8,me),_("a",{onClick:Y=>E(n)},"查看",8,fe)]),_:2},1024)]),_:1},8,["data-source","loading","pagination"])]),_:1}),s(D,{visible:g.value,"onUpdate:visible":e[11]||(e[11]=n=>g.value=n),title:M.value,"confirm-loading":j.value,onOk:K,onCancel:Q},{default:o(()=>[s(X,{ref_key:"formRef",ref:P,model:a.value,rules:N,"label-col":{span:6},"wrapper-col":{span:16}},{default:o(()=>[s(i,{label:"公司名称",name:"name"},{default:o(()=>[s(t,{value:a.value.name,"onUpdate:value":e[1]||(e[1]=n=>a.value.name=n)},null,8,["value"])]),_:1}),s(i,{label:"联系人",name:"contact_person"},{default:o(()=>[s(t,{value:a.value.contact_person,"onUpdate:value":e[2]||(e[2]=n=>a.value.contact_person=n)},null,8,["value"])]),_:1}),s(i,{label:"地址",name:"address"},{default:o(()=>[s(t,{value:a.value.address,"onUpdate:value":e[3]||(e[3]=n=>a.value.address=n)},null,8,["value"])]),_:1}),s(i,{label:"区域",name:"area"},{default:o(()=>[s(t,{value:a.value.area,"onUpdate:value":e[4]||(e[4]=n=>a.value.area=n),placeholder:"请输入客户所在区域"},null,8,["value"])]),_:1}),s(i,{label:"联系电话",name:"contact_phone"},{default:o(()=>[s(t,{value:a.value.contact_phone,"onUpdate:value":e[5]||(e[5]=n=>a.value.contact_phone=n)},null,8,["value"])]),_:1}),s(i,{label:"营业执照号",name:"license_number"},{default:o(()=>[s(t,{value:a.value.license_number,"onUpdate:value":e[6]||(e[6]=n=>a.value.license_number=n)},null,8,["value"])]),_:1}),s(i,{label:"三类医疗器械经营许可证编号",name:"class3_license_number","label-col":{span:24}},{default:o(()=>[s(t,{value:a.value.class3_license_number,"onUpdate:value":e[7]||(e[7]=n=>a.value.class3_license_number=n)},null,8,["value"])]),_:1}),s(i,{label:"二类医疗器械经营备案编号",name:"class2_record_number","label-col":{span:24}},{default:o(()=>[s(t,{value:a.value.class2_record_number,"onUpdate:value":e[8]||(e[8]=n=>a.value.class2_record_number=n)},null,8,["value"])]),_:1}),s(i,{label:"三类许可证文件",name:"class3_license_file","label-col":{span:24}},{default:o(()=>[s(S,{"file-list":a.value.class3_license_file,"onUpdate:fileList":e[9]||(e[9]=n=>a.value.class3_license_file=n),"before-upload":n=>O(n,"class3"),"max-count":1,accept:".jpg,.jpeg",onPreview:k},{default:o(()=>[s(v,null,{default:o(()=>[s(I),e[14]||(e[14]=q(" 上传文件 "))]),_:1})]),_:1},8,["file-list","before-upload"]),e[15]||(e[15]=_("span",{class:"upload-tip"},"仅支持JPG格式，最大1.8MB",-1))]),_:1}),s(i,{label:"二类备案凭证文件",name:"class2_record_file","label-col":{span:24}},{default:o(()=>[s(S,{"file-list":a.value.class2_record_file,"onUpdate:fileList":e[10]||(e[10]=n=>a.value.class2_record_file=n),"before-upload":n=>O(n,"class2"),"max-count":1,accept:".jpg,.jpeg,.pdf",onPreview:k},{default:o(()=>[s(v,null,{default:o(()=>[s(I),e[16]||(e[16]=q(" 上传文件 "))]),_:1})]),_:1},8,["file-list","before-upload"]),e[17]||(e[17]=_("span",{class:"upload-tip"},"支持JPG、PDF格式，最大5MB",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title","confirm-loading"]),s(D,{visible:x.value,"onUpdate:visible":e[12]||(e[12]=n=>x.value=n),title:"查看文件",footer:null,onCancel:G},{default:o(()=>[_("div",null,[e[19]||(e[19]=_("p",null,"二类备案凭证文件:",-1)),b.value.class2_record_file?(h(),w("div",ve,[_("img",{src:b.value.class2_record_file,alt:"二类备案凭证",style:{"max-width":"100%"}},null,8,ge)])):(h(),w("div",be,e[18]||(e[18]=[_("span",null,"暂无文件",-1)])))]),_("div",we,[e[21]||(e[21]=_("p",null,"三类许可证文件:",-1)),b.value.class3_license_file?(h(),w("div",he,[_("img",{src:b.value.class3_license_file,alt:"三类许可证",style:{"max-width":"100%"}},null,8,ye)])):(h(),w("div",xe,e[20]||(e[20]=[_("span",null,"暂无文件",-1)])))])]),_:1},8,["visible"])])}}},Me=Z(Ue,[["__scopeId","data-v-a27a9237"]]);export{Me as default};
